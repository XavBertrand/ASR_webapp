<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Administration - Utilisateurs</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='app_shell.css') }}">
</head>
<body class="page-admin">
    <header class="topbar">
        <div class="topbar-inner container">
            <h1>Administration — Utilisateurs</h1>
            <div class="topbar-actions">
                <a class="btn btn-ghost" href="/">← Retour app</a>
                <a class="btn btn-ghost" href="/admin/2fa/setup">2FA admin</a>
                <a class="btn btn-ghost" href="/admin/audit">Audit</a>
                <form method="post" action="/logout">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button class="btn btn-secondary" type="submit">Déconnexion</button>
                </form>
            </div>
        </div>
    </header>
    <main class="container main-content">
        <div id="flash" class="alert"></div>
        <section class="card stack">
            <h2>Créer un utilisateur</h2>
            <form id="create-form" class="stack">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="field">
                    <label for="new-username">Identifiant</label>
                    <input id="new-username" name="username" required>
                </div>
                <div class="field">
                    <label for="new-email">Email (optionnel)</label>
                    <input id="new-email" name="email" type="email" autocomplete="email">
                </div>
                <div class="field">
                    <label for="new-role">Rôle</label>
                    <select id="new-role" name="role">
                        <option value="user">user</option>
                        <option value="admin">admin</option>
                    </select>
                </div>
                <div class="field">
                    <label for="new-password">Mot de passe initial</label>
                    <input id="new-password" name="password" type="password" required minlength="8">
                </div>
                <button class="btn btn-primary btn-block" type="submit">Créer</button>
            </form>
        </section>

        <section class="card stack">
            <h2>Utilisateurs</h2>
            <div class="table-wrap">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>Identifiant</th>
                            <th>Email</th>
                            <th>Email vérifié</th>
                            <th>Rôle</th>
                            <th>Actif</th>
                            <th>2FA</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const csrfToken = "{{ csrf_token }}";

        function flash(msg, ok = true) {
            const el = document.getElementById('flash');
            el.textContent = msg;
            el.className = ok ? 'alert success' : 'alert error';
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 4000);
        }

        async function fetchUsers() {
            const res = await fetch('/api/admin/users', {credentials: 'same-origin'});
            const data = await res.json();
            const tbody = document.querySelector('#users-table tbody');
            tbody.innerHTML = '';
            data.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td data-label="Identifiant">${u.username}</td>
                    <td data-label="Email">
                        <input data-field="email" data-id="${u.id}" type="email" value="${u.email || ''}" placeholder="email@domaine.tld">
                    </td>
                    <td data-label="Email vérifié">
                        <label class="inline-check">
                            <input data-field="email_verified" data-id="${u.id}" type="checkbox" ${u.email_verified ? 'checked' : ''}>
                            <span>Vérifié</span>
                        </label>
                    </td>
                    <td data-label="Rôle">${u.role}</td>
                    <td data-label="Actif"><span class="pill ${u.is_active ? 'active' : 'inactive'}">${u.is_active ? 'actif' : 'inactif'}</span></td>
                    <td data-label="2FA">${u.twofa_enabled ? '✅' : '—'}</td>
                    <td data-label="Actions" class="admin-actions">
                        <button class="btn-mini btn-secondary" data-action="save-email" data-id="${u.id}">Enregistrer email</button>
                        <button class="btn-mini ${u.is_active ? 'btn-danger' : 'btn-secondary'}" data-action="toggle" data-id="${u.id}">${u.is_active ? 'Désactiver' : 'Activer'}</button>
                        <button class="btn-mini btn-danger" data-action="reset" data-id="${u.id}">Reset mot de passe</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const payload = {
                username: form.username.value,
                password: form.password.value,
                role: form.role.value,
                email: form.email.value,
            };
            const res = await fetch('/api/admin/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
                body: JSON.stringify(payload),
                credentials: 'same-origin'
            });
            const data = await res.json();
            if (res.ok) {
                flash('Utilisateur créé');
                form.reset();
                fetchUsers();
            } else {
                flash(data.error || 'Erreur', false);
            }
        });

        document.querySelector('#users-table').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const id = btn.dataset.id;
            const action = btn.dataset.action;
            if (action === 'save-email') {
                const row = btn.closest('tr');
                const emailInput = row.querySelector('input[data-field="email"]');
                const verifiedCheckbox = row.querySelector('input[data-field="email_verified"]');
                const payload = {
                    email: emailInput.value,
                    email_verified: verifiedCheckbox.checked,
                };
                const res = await fetch(`/api/admin/users/${id}/email`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
                    body: JSON.stringify(payload),
                    credentials: 'same-origin'
                });
                const data = await res.json();
                if (res.ok) {
                    flash('Email mis à jour');
                    fetchUsers();
                } else {
                    flash(data.error || 'Erreur', false);
                }
                return;
            }
            if (action === 'toggle') {
                const res = await fetch(`/api/admin/users/${id}/toggle-active`, {
                    method: 'POST',
                    headers: {'X-CSRF-Token': csrfToken},
                    credentials: 'same-origin'
                });
                const data = await res.json();
                if (res.ok) {
                    flash(data.is_active ? 'Compte activé' : 'Compte désactivé');
                    fetchUsers();
                } else {
                    flash(data.error || 'Erreur', false);
                }
            }
            if (action === 'reset') {
                const pwd = prompt('Nouveau mot de passe:');
                if (!pwd) return;
                const res = await fetch(`/api/admin/users/${id}/reset-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken},
                    body: JSON.stringify({password: pwd}),
                    credentials: 'same-origin'
                });
                const data = await res.json();
                if (res.ok) {
                    flash('Mot de passe réinitialisé');
                } else {
                    flash(data.error || 'Erreur', false);
                }
            }
        });

        fetchUsers();
    </script>
</body>
</html>
